Refactor this code following these principles:
- Extract reusable functions
- Improve naming for clarity
- Reduce complexity and nesting
- Add proper error handling
- Improve type safety
- Maintain backward compatibility